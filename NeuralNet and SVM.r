library(dplyr)
library(caret)
library(RCurl)
library(dplyr)
library(nnet) 
library(neuralnet)  
library(NeuralNetTools)  

balancetrain <- read.csv("FINAL_TRAIN.csv", header = TRUE) #Import in balanced training data
balancetest <- read.csv("FINAL_TEST.csv", header = TRUE) #Import in balanced testing data

balancetrain <- na.omit(balancetrain) #Omit any NA's
balancetest <- na.omit(balancetest)

balancetrain$cluster <- as.factor(balancetrain$cluster) #Setting cluster and heat illnesses as categories rather than values
balancetest$cluster <- as.factor(balancetest$cluster)

balancetrain$heat_illness <- as.factor(balancetrain$heat_illness)
balancetest$heat_illness <- as.factor(balancetest$heat_illness)

balancetest$year <- NULL
#balancetest$month <- NULL
balancetrain$year <- NULL
#balancetrain$month <- NULL

balancetest <- subset(balancetest, select = -c(X,abovepoverty_pctile, ozone_pctile,employed_pctile, dieselpm_pctile, insured_pctile,pm25_pctile,h20contam_pctile,ownsevere_pctile, automobile_pctile,treecanopy_pctile)) #Categories used in this round
balancetrain <- subset(balancetrain, select = -c(X,abovepoverty_pctile, ozone_pctile,employed_pctile, dieselpm_pctile, insured_pctile,pm25_pctile,h20contam_pctile,treecanopy_pctile,ownsevere_pctile, automobile_pctile,treecanopy_pctile))

head(balancetest)

accuracy_results <- function(tree, test){ #Calculates accuracy of predictions using partioned test data
  predictions <- predict(tree, test, type = 'class')
  table_mat <- table(test$heat_illness, predictions)
  print(table_mat)
  accuracy_Test <- sum(diag(table_mat))/sum(table_mat)
  print(paste("Accuracy for test", accuracy_Test))
}

support_vector_new <- function(balancetrain) { #returns the model
    train <- balancetrain[sample(nrow(balancetrain), 150000), ]
    train_control <- trainControl(method="repeatedcv", number=5, repeats=2)
    fit <- train(heat_illness ~., data = train, method = "svmRadial", trControl = train_control,  preProcess = c("center","scale"), tuneLength = 10)
    return(fit)
    }

sv <- support_vector_new(balancetrain) #Runs model

neural_net_new <- function(balancetrain) { #returns the model 
    train <- balancetrain
    train <- sample_n(train, 500000)
    fitControl <- trainControl(## 10-fold CV
                           method = "repeatedcv",
                           number = 5,
                           ## repeated ten times
                           repeats = 2)
    nn <- train(heat_illness~., data = train, method='nnet', tuneGrid=expand.grid(size=c(6), decay=c(0.1)),maxit = 125,  trControl = fitControl)
    return(nn)
}

nn <- neural_net_new(balancetrain)

#NN Test and importance
accuracy_results(nn, balancetest) #Accuracy
importanceNN = varImp(nn, scale=FALSE) #Variable importance (May vary based on seed)
importanceNN

#Support Vector Machine Test
accuracy_results(sv, balancetest)
importanceSV = varImp(sv, scale=FALSE)
importanceSV

