daily_temp <- read.csv('daily_temp_zip_04t13.csv', header = TRUE)
heat_hospitalizations <- read.csv('Heat hospitalisations California.csv', header = TRUE)
#loads in data sets as variables
print(heat_hospitalizations)
print(daily_temp)

#load in new data and add cluster number
library(plyr)
cluster_zip <- read.csv('15 clusters zip.csv', header = TRUE)
cluster_zip <- rename(cluster_zip, c("X1" = "zipcode"))
cluster_zip <- rename(cluster_zip, c("X2" = "cluster"))
cluster_zip <- subset(cluster_zip, select = c('zipcode', 'cluster'))
balance_example <- merge(combined_heathosp, cluster_zip, by = c('zipcode'), all.x = TRUE)
print(balance_example)
balance_example <- subset(balance_example, 
                          select = c('heat_illness', 'month', 'year', 'temp_diff', 'mintemp', 'maxtemp', 'cluster'))
balance_example <- subset(balance_example, is.na(balance_example) == FALSE)

#Function to SMOTE data by cluster
smotecluster <- function(datafile){
  library('DMwR')
  library('plyr')
  #change heat illness into yes or no
  datafile$heat_illness[datafile$heat_illness > 1] <- 1
  #make date and heat illness into factors
  datafile$heat_illness = as.factor(datafile$heat_illness)
  datafile$month = as.factor(datafile$month)
  datafile$year = as.factor(datafile$year)
  datafile$cluster = as.factor(datafile$cluster)
  #create empty data frame
  completeSmote <- data.frame()
  #find number of clusters in datafile
  numofclusters <- length(unique(datafile$cluster))
  #for loop that performs SMOTE for each region
  for (var in 1:numofclusters){
    region <- subset(datafile, datafile['cluster'] == var)
    balanced_region <- SMOTE(heat_illness ~., region,  perc.over = 20000, k = 3, perc.under = 200)
    completeSmote <- rbind(completeSmote, balanced_region)
  }
  return(completeSmote)
}

#SMOTE function on data
smoteData <- smotecluster(balance_example)

#splitting the data set
library(caTools)
split <- sample.split(smoteData$heat_illness, SplitRatio = 0.75)
balancedtrain <- subset(smoteData, split == TRUE)
balancedtest <- subset(smoteData, split == FALSE)

as.data.frame(table(balancetrain$heat_illness))
as.data.frame(table(balancetest$heat_illness))

#create the files
write.csv(balancetrain,"~/Desktop/Data Sets/15 cluster training data.csv", row.names = FALSE)
write.csv(balancetest,"~/Desktop/Data Sets/15 cluster testing data.csv", row.names = FALSE)